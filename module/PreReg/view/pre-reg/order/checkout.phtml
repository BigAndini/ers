<?php

$title = 'My Shopping Cart';
$this->headTitle($title);
?>

<h1><?php echo $this->escapeHtml($title); ?></h1>

<?php 
echo $this->navigation()
    ->menu('checkout_nav')
    ->setUlClass('nav navbar-nav navbar-checkout');
?>
<div class="clear-both"></div>

<?php
    $form = $this->form;
    $form->setAttribute('action', $this->url('order', array('action' => 'checkout')));
    $form->prepare();
?>
<div class="order-info order-info-left">
    <h1>Purchaser</h1>
    <?php $purchaser = $order->getPurchaser(); ?>
    <?php if($purchaser) : ?>
        <h2><?php echo $purchaser->getPrename().' '.$purchaser->getSurname(); ?></h2>
        <p>The purchaser will receive all eTickets for all registered participants. If you have provided an email address for a participant this participant will be informed once the ticket is payed and will be able to download the eTicket on his own aswell.</p>
        <h3>We will send all information to: <?php echo $purchaser->getEmail(); ?></h3>
    <?php else: ?>
        <?php $form->get('submit')->setAttribute('disabled', 'disabled'); ?>
        <a href="<?php echo $this->url('order', array('action' => 'register')); ?>">choose Purchaser</a>
    <?php endif; ?>
</div>
<div class="order-info order-info-right">
    <h1>Payment</h1>
    <?php $paymenttype = $order->getPaymentType(); ?>
    <?php if($paymenttype) : ?>
        <h3><?php echo $paymenttype->getName(); ?></h3>
        <p><?php echo $paymenttype->getExplanation(); ?></p>
    <?php else: ?>
        <?php $form->get('submit')->setAttribute('disabled', 'disabled'); ?>
        <a href="<?php echo $this->url('order', array('action' => 'payment')); ?>">choose paymenttype</a>
    <?php endif; ?>
    <!--<h3>Bank Transfer</h3>
    <p>After successfull purchase you will see the bank account data to transfer the money to. When we matched your payment to your order you will be informed and can download your eTickets.</p>
    <h3>Credit Card</h3>
    <p>After purchase you will see the credit card formular. After successful payment you will be able to download your eTickets.</p>
    <h3>PayPal</h3>
    <p>After purchase you will be redirected to a PayPal page. After successful payment you will be able to download your eTickets.</p>-->    
</div>
<div class="clear-both"></div>
<div>
    <h1>Shopping Cart</h1>
        <div>
        <?php 
            $sum = 0;
            foreach ($order->getPackages() as $package) : 
                if(count($package->getItems()) == 0) {
                    continue;
                }
                $user = $package->getParticipant();
            
                if($user->getPrename() == '' && $user->getSurname() == '') :
                    $participant = 'unassigned items';
                else:
                    $participant = $user->getPrename().' '.$user->getSurname();
                endif;
        ?>
            <div class="package">
                <h3>
                    <?php echo $participant; ?>
                    <span style="font-size: 14px;">
                        <a href="<?php echo $this->url('participant', array('action'=>'edit', 'id' => $user->getSessionId()));?>"><?php echo $this->translate('Edit'); ?></a>
                        <a href="<?php echo $this->url('participant', array('action'=>'delete', 'id' => $user->getSessionId()));?>"><?php echo $this->translate('Delete'); ?></a>
                    </span>
                </h3>
                
                <?php if(count($package->getItems()) != 0): ?>
                <table class="table">
                    <tr>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Price</th>
                        <th></th>
                    </tr>
                    <?php
                    $subtotal = 0;
                    foreach ($package->getItems() as $item) : 
                        $subtotal += $item->getPrice();
                        $sum += $item->getPrice();
                        ?>
                        <tr>
                            <td><?php echo $item->getName(); ?></td>
                            <td><?php echo $item->getAmount(); ?></td>
                            <td><?php echo $this->currencyFormat($item->getPrice(), 'EUR', null, 'de_DE'); ?></td>
                            <td>
                                <?php 
                                if($user->getSessionId() === null) {
                                    $user_id = 0;
                                } else {
                                    $user_id = $user->getSessionId();
                                }
                                ?>
                                <a href="<?php echo $this->url('product', 
                                        array(
                                            'action' => 'view', 
                                            'product_id' => $item->getProductId(), 
                                            'participant_id' => $user_id,
                                            'item_id' => $item->getSessionId()
                                        )) ?>">edit</a>
                                <a href="<?php echo $this->url('product', 
                                        array(
                                            'action' => 'delete', 
                                            'product_id' => $item->getProductId(), 
                                            'participant_id' => $user_id,
                                            'item_id' => $item->getSessionId()
                                        )) ?>">delete</a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    <tr>
                        <td></td>
                        <td>Subtotal:</td>
                        <td><?php echo $this->currencyFormat($subtotal, 'EUR', null, 'de_DE'); ?></td>
                        <td></td>
                    </tr>
                </table>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>
        <div>
            <h3>Total Amount: <?php echo $this->currencyFormat($sum, 'EUR', null, 'de_DE'); ?></h3>
        </div>
    </div>
 </div>


<div class="clear-both"></div>
<div class="checkout">
    <?php
        if(count($order->getItems()) == 0):
            $form->get('submit')->setAttribute('disabled', 'disabled');
        endif;
        echo $this->form()->openTag($form);
    
        if($form->get('submit')->getAttribute('disabled') == 'disabled'):
    ?>
    <div class="alert alert-danger">
        <h4>Please add needed information to checkout</h4>
        <?php if(count($order->getItems()) == 0) : ?>
            <p><a href="<?php echo $this->url('product'); ?>">Add products</a> to your shopping cart first.</p>
        <?php endif; ?>
        <?php if(!$order->getPurchaser()) : ?>
            <p>To purchase this order <a href="<?php echo $this->url('order', array('action' => 'register')); ?>">choose/add a purchaser</a>.</p>
        <?php endif; ?>
        <?php if(!$order->getPaymentType()) : ?>
            <p>To purchase this order <a href="<?php echo $this->url('order', array('action' => 'payment')); ?>">choose a paymenttype</a>.</p>
        <?php endif; ?>
        
    </div>
    <?php
        else:
            ?>
            <p>
            <?php
                #echo $this->formLabel($form->get('terms'));
                echo $this->formElement($form->get('terms'));
            ?>
                I accept the <a href="<?php echo $this->url('info', array('action' => 'terms')) ?>">terms and conditions</a>
            </p>
        <?php 
            echo $this->formElementErrors($form->get('terms')); 
        endif;
        echo $this->formSubmit($form->get('submit'));
        echo $this->formHidden($form->get('csrf'));
        echo $this->form()->closeTag(); 
    ?>
</div>